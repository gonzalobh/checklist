<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Hotel Sales Flow</title>

<style>
  :root{
    --bg0:#1f1f1f;
    --bg1:#1f1f1f;
    --panel:#262626;
    --panel2:#2c2c2c;
    --border:#3a3a3a;
    --border2:#4a4a4a;
    --text:#f5f5f5;
    --muted:#b3b3b3;
    --muted2:#8c8c8c;

    --ok:#22c55e;
    --warn:#f59e0b;
    --bad:#ef4444;

    --shadow: 0 8px 24px rgba(0,0,0,.35);
    --shadow2: 0 4px 12px rgba(0,0,0,.25);
    --radius: 12px;
    --radius2: 10px;

    --focus: 0 0 0 3px rgba(83,155,245,.35);
  }

  body.light{
    --bg0:#f7f6f3;
    --bg1:#f7f6f3;
    --panel:#ffffff;
    --panel2:#ffffff;
    --border:#e6e5e2;
    --border2:#d6d5d2;
    --text:#2f3437;
    --muted:#6b6f76;
    --muted2:#9aa0a6;

    --ok:#16a34a;
    --warn:#d97706;
    --bad:#dc2626;

    --shadow: 0 6px 18px rgba(15,23,42,.10);
    --shadow2: 0 3px 10px rgba(15,23,42,.10);

    --focus: 0 0 0 3px rgba(83,155,245,.25);
  }

  *{ box-sizing:border-box; }
  html,body{ height:100%; }
  body{
    margin:0;
    font-family: "Inter", "Segoe UI", system-ui, -apple-system, Roboto, Arial, sans-serif;
    color: var(--text);
    background: var(--bg0);
    letter-spacing: .1px;
  }

  body.light{
    background: var(--bg0);
  }

  .hidden{ display:none; }

  .app{
    max-width: 1120px;
    margin: 0 auto;
    padding: 20px;
  }

  /* Top bar */
  .topbar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    margin: 4px 0 16px;
  }
  .brand{
    display:flex;
    align-items:center;
    gap:10px;
    min-width: 220px;
  }
  .logo{
    width:38px; height:38px;
    border-radius: 10px;
    background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
    border: 1px solid var(--border);
    box-shadow: var(--shadow2);
  }
  .brand h1{
    font-size: 14px;
    margin:0;
    font-weight: 700;
    letter-spacing: .4px;
    color: var(--text);
  }
  .brand p{
    margin:0;
    font-size: 12px;
    color: var(--muted);
  }

  .theme-toggle{
    display:flex;
    align-items:center;
    gap:10px;
    padding: 6px 10px;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: var(--panel);
    box-shadow: var(--shadow2);
  }
  .theme-toggle span{
    font-size: 12px;
    color: var(--muted);
    font-weight: 650;
    letter-spacing: .2px;
  }
  .switch{
    position:relative;
    width: 44px;
    height: 24px;
  }
  .switch input{
    opacity:0;
    width:0;
    height:0;
  }
  .slider{
    position:absolute;
    cursor:pointer;
    inset:0;
    background: var(--panel2);
    border: 1px solid var(--border);
    transition: .2s;
    border-radius: 999px;
  }
  .slider::before{
    content:"";
    position:absolute;
    height: 18px;
    width: 18px;
    left: 3px;
    top: 2px;
    background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.60));
    border-radius: 50%;
    transition: .2s;
    box-shadow: 0 2px 6px rgba(0,0,0,.25);
  }
  .switch input:checked + .slider{
    background: rgba(83,155,245,.35);
    border-color: rgba(83,155,245,.45);
  }
  .switch input:checked + .slider::before{
    transform: translateX(20px);
    background: linear-gradient(180deg, rgba(255,255,255,.98), rgba(255,255,255,.76));
  }

  .shell{
    border-radius: var(--radius);
    border: 1px solid var(--border);
    background: var(--panel);
    box-shadow: var(--shadow);
    overflow:hidden;
  }

  .grid{
    display:grid;
    grid-template-columns: 1fr;
  }

  .card{
    padding: 18px;
  }

  /* Header of screens */
  .header{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:12px;
    padding: 18px 18px 0;
  }
  .header h2, .header h3{
    margin:0;
    font-weight: 750;
    letter-spacing: .2px;
  }
  .header h2{ font-size: 18px; }
  .header h3{ font-size: 16px; }
  .sub{
    margin-top:6px;
    color: var(--muted);
    font-size: 13px;
    line-height: 1.35;
  }

  .content{
    padding: 14px 18px 18px;
  }

  /* Buttons */
  button{
    appearance:none;
    border: 1px solid var(--border);
    color: var(--text);
    background: var(--panel2);
    padding: 12px 14px;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 650;
    cursor:pointer;
    transition: transform .08s ease, border-color .15s ease, background .15s ease, opacity .15s ease;
    box-shadow: var(--shadow2);
  }
  button:hover{ border-color: var(--border2); }
  button:active{ transform: translateY(1px); }
  button:focus{ outline:none; box-shadow: var(--shadow2), var(--focus); }

  .btn-row{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
  }
  .btn-full{
    width:100%;
  }
  .btn-primary{
    border-color: rgba(83,155,245,.45);
    background: rgba(83,155,245,.18);
  }
  .btn-ghost{
    background: transparent;
    box-shadow:none;
  }
  .btn-danger{
    border-color: rgba(239,68,68,.28);
    background: rgba(239,68,68,.14);
  }

  /* Inputs */
  .field{
    display:flex;
    flex-direction:column;
    gap:8px;
    margin-bottom: 12px;
  }
  label{
    font-size: 12px;
    color: var(--muted);
    font-weight: 650;
    letter-spacing: .2px;
  }
  input{
    width:100%;
    padding: 12px 12px;
    font-size: 15px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: var(--panel);
    color: var(--text);
    box-shadow: inset 0 0 0 1px rgba(0,0,0,.05);
  }
  input::placeholder{ color: var(--muted2); }
  input:focus{
    outline:none;
    border-color: rgba(255,255,255,.24);
    box-shadow: var(--focus);
  }

  /* Divider */
  .divider{
    height:1px;
    background: var(--border);
    margin: 14px 0;
  }

  /* Guest list */
  .list{
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
  }
  @media (max-width: 920px){ .list{ grid-template-columns: repeat(2, 1fr);} }
  @media (max-width: 560px){ .list{ grid-template-columns: 1fr;} }

  .guest-card{
    border-radius: 16px;
    border: 1px solid var(--border);
    background: var(--panel);
    padding: 12px;
    box-shadow: var(--shadow2);
  }
  .guest-top{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
    margin-bottom: 10px;
  }
  .room{
    display:flex;
    align-items:center;
    gap:10px;
  }
  .pill{
    font-size: 12px;
    font-weight: 750;
    letter-spacing: .4px;
    padding: 6px 10px;
    border-radius: 999px;
    border: 1px solid var(--border);
    color: var(--text);
    background: var(--panel2);
    white-space:nowrap;
  }
  .pill.ok{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.10); }
  .pill.warn{ border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.10); }
  .pill.bad{ border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.10); }

  .mini{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin-top: 8px;
  }
  .mini .tag{
    font-size: 11px;
    color: var(--muted);
    border: 1px solid var(--border);
    background: transparent;
    padding: 5px 8px;
    border-radius: 999px;
  }

  .guest-actions{
    display:flex;
    gap:8px;
    margin-top: 10px;
  }
  .guest-actions button{
    flex:1;
    padding: 10px 12px;
    border-radius: 12px;
    font-size: 13px;
    box-shadow:none;
  }

  /* Stages */
  .stage-grid{
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
  }
  @media (max-width: 760px){ .stage-grid{ grid-template-columns: 1fr; } }

  .stage{
    padding: 14px;
    border-radius: 16px;
    border: 1px solid var(--border);
    cursor:pointer;
    background: var(--panel);
    box-shadow: var(--shadow2);
    transition: transform .08s ease, border-color .15s ease;
  }
  .stage:hover{ border-color: var(--border2); }
  .stage:active{ transform: translateY(1px); }

  .stage-top{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:10px;
  }
  .stage h4{
    margin:0;
    font-size: 14px;
    font-weight: 800;
    letter-spacing: .2px;
  }
  .stage p{
    margin:6px 0 0;
    font-size: 12px;
    color: var(--muted);
    line-height:1.35;
  }

  .progress{
    margin-top: 12px;
    height: 10px;
    border-radius: 999px;
    background: rgba(255,255,255,.06);
    border: 1px solid var(--border);
    overflow:hidden;
  }
  .bar{
    height:100%;
    width: 0%;
    background: rgba(83,155,245,.45);
    border-right: 1px solid rgba(83,155,245,.30);
  }

  /* Flow list */
  .flow-list{
    display:flex;
    flex-direction:column;
    gap: 10px;
  }
  .item{
    padding: 14px;
    border-radius: 16px;
    border: 1px solid var(--border);
    background: var(--panel);
    box-shadow: var(--shadow2);
    position:relative;
    overflow:hidden;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 18px;
  }
  .item.dim{
    opacity: .40;
    filter: grayscale(.1);
  }
  .item.active{
    border-color: rgba(255,255,255,.26);
  }
  .item.active::before{
    content:"";
    position:absolute;
    inset:-40px -60px auto auto;
    width: 220px;
    height: 120px;
    background: radial-gradient(circle at 30% 30%, rgba(83,155,245,.22), transparent 65%);
    transform: rotate(12deg);
    pointer-events:none;
  }
  .item strong{
    display:block;
    font-size: 18px;
    font-weight: 800;
    letter-spacing: .2px;
  }
  .item-sub{
    font-size: 15px;
    color: rgba(243,245,248,.65);
    font-style: italic;
  }
  body.light .item-sub{
    color: rgba(30,41,59,.70);
  }
  .item-actions{
    display:flex;
    gap:12px;
    flex-wrap:wrap;
  }
  .item-actions button{
    padding: 10px 18px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,.35);
    box-shadow:none;
    font-weight: 700;
    letter-spacing: .2px;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    background: transparent;
  }
  .actions .icon{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    width: 22px;
    height: 22px;
    border-radius: 999px;
    font-size: 14px;
    font-weight: 900;
  }
  .actions .accept{
    color: rgba(203,255,221,.95);
    border-color: rgba(34,197,94,.45);
    box-shadow: inset 0 0 0 1px rgba(34,197,94,.15);

  }
  body.light .actions .accept{
    color: #0f5132;
    border-color: rgba(22,163,74,.40);
  }
  body.light .item-actions button{
    color: rgba(15,23,42,.75);
    border-color: rgba(15,23,42,.20);
  }
  .item-actions button.active{
    border-color: rgba(255,255,255,.85);
    color: rgba(255,255,255,.92);
  }
  body.light .item-actions button.active{
    border-color: rgba(15,23,42,.55);
    color: #0f172a;
  }
  .item-actions button.accepted{
    border-color: rgba(34,197,94,.90);
    color: rgba(129,255,186,.95);
    box-shadow: 0 0 0 1px rgba(34,197,94,.20);
  }
  body.light .item-actions button.accepted{
    border-color: rgba(22,163,74,.60);
    color: #166534;
  }
  .item-actions button.muted{
    color: rgba(243,245,248,.45);
  }

  .badge{
    margin-top: 10px;
    font-size: 12px;
    color: var(--muted);
    display:flex;
    align-items:center;
    gap:8px;
  }
  .dot{
    width:10px;height:10px;border-radius:999px;
    background: var(--panel2);
    border: 1px solid var(--border);
  }

  /* Toast */
  .toast{
    position: fixed;
    bottom: 16px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--panel);
    border: 1px solid var(--border);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    color: var(--text);
    padding: 10px 12px;
    border-radius: 14px;
    box-shadow: var(--shadow2);
    font-size: 13px;
    display:none;
    max-width: 92vw;
  }

  /* Small helpers */
  .row{
    display:flex; gap:10px; flex-wrap:wrap;
  }
  .grow{ flex:1; }
  .right{ margin-left:auto; }

  .muted{ color: var(--muted); }
  .kpi{
    display:flex; gap:10px; flex-wrap:wrap;
    margin-top: 10px;
  }
  .kpi .box{
    flex:1;
    min-width: 160px;
    border: 1px solid var(--border);
    background: var(--panel);
    border-radius: 16px;
    padding: 12px;
  }

  /* Flow layout */
  .flow-layout{
    display:grid;
    grid-template-columns: 260px 1fr;
    gap: 16px;
  }
  @media (max-width: 900px){
    .flow-layout{
      grid-template-columns: 1fr;
    }
  }
  .stage-nav{
    display:flex;
    flex-direction:column;
    gap: 12px;
  }
  .stage-nav .stage{
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.04), var(--shadow2);
  }
  .stage-nav .stage.active{
    border-color: rgba(83,155,245,.45);
    box-shadow: 0 0 0 1px rgba(83,155,245,.25), var(--shadow);
  }
  .flow-main{
    display:flex;
    flex-direction:column;
    gap: 12px;
  }
  .kpi .box b{ display:block; font-size: 16px; }
  .kpi .box span{ color: var(--muted); font-size: 12px; }

  a{ color: inherit; }
</style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Recepción</h1>
          <p>Checklist guiado para vender más (sin campos ni complicaciones)</p>
        </div>
      </div>

      <div class="row right">
        <div class="theme-toggle" role="group" aria-label="Tema">
          <span id="themeLabel">Modo oscuro</span>
          <label class="switch">
            <input id="themeSwitch" type="checkbox" aria-label="Cambiar a modo claro">
            <span class="slider"></span>
          </label>
        </div>
        <button class="btn-ghost" onclick="hardReset()">Reiniciar todo</button>
      </div>
    </div>

    <div class="shell">
      <!-- HOME -->
      <div id="home">
        <div class="header">
          <div>
            <h2>Inicio</h2>
            <div class="sub">Elige una acción. La idea es que sea <b>rápido, repetible y controlable</b>.</div>
          </div>
        </div>

        <div class="content">
          <div class="btn-row">
            <button class="btn-primary" onclick="showNew()">+ Nuevo huésped</button>
            <button onclick="showSearch()">Buscar habitación</button>
          </div>

          <div class="divider"></div>

          <div class="kpi">
            <div class="box">
              <b id="kpiActive">0</b>
              <span>Huéspedes activos</span>
            </div>
            <div class="box">
              <b id="kpiToday">—</b>
              <span>Hoy (solo referencia)</span>
            </div>
            <div class="box">
              <b id="kpiTips">2s</b>
              <span>Tiempo objetivo por acción</span>
            </div>
          </div>
        </div>
      </div>

      <!-- NUEVO -->
      <div id="newGuest" class="hidden">
        <div class="header">
          <div>
            <h3>Nuevo huésped</h3>
            <div class="sub">Solo escribe la habitación. Sin nombre. Sin fricción.</div>
          </div>
        </div>

        <div class="content">
          <div class="field">
            <label>Habitación</label>
            <input id="roomInput" inputmode="numeric" placeholder="Ej: 205">
          </div>

          <div class="btn-row">
            <button class="btn-primary" onclick="createGuest()">Crear y entrar</button>
            <button class="btn-ghost" onclick="goHome()">Cancelar</button>
          </div>

          <div class="sub" style="margin-top:12px;">
            Tip: si la habitación ya existe, te llevará a esa ficha para continuar.
          </div>
        </div>
      </div>

      <!-- BUSCAR -->
      <div id="search" class="hidden">
        <div class="header">
          <div>
            <h3>Huéspedes activos</h3>
            <div class="sub">Busca por habitación y entra con 1 click.</div>
          </div>
        </div>

        <div class="content">
          <div class="field">
            <label>Buscar</label>
            <input id="searchInput" placeholder="Escribe: 101, 205, 12..." oninput="renderGuestList()">
          </div>

          <div id="guestList" class="list"></div>

          <div class="divider"></div>

          <div class="btn-row">
            <button class="btn-ghost btn-full" onclick="goHome()">Volver</button>
          </div>
        </div>
      </div>

      <!-- ETAPAS -->
      <div id="stages" class="hidden">
        <div class="header">
          <div>
            <h3>Habitación <span id="roomTitle" style="opacity:.92"></span></h3>
            <div class="sub">Entra a una etapa. El sistema te marca progreso y qué falta.</div>
          </div>
          <div class="row">
            <button class="btn-danger" onclick="deleteCurrent()">Borrar huésped</button>
          </div>
        </div>

        <div class="content">
          <div class="stage-grid">
            <div class="stage" onclick="openStage('checkin')">
              <div class="stage-top">
                <div>
                  <h4>Check-in</h4>
                  <p>Primer minuto = más ventas. Guion corto, sin pensar.</p>
                </div>
                <div id="badge_checkin" class="pill">Pendiente</div>
              </div>
              <div class="progress"><div id="bar_checkin" class="bar"></div></div>
            </div>

            <div class="stage" onclick="openStage('stay')">
              <div class="stage-top">
                <div>
                  <h4>Estadía</h4>
                  <p>Upsell suave. Detecta oportunidades sin molestar.</p>
                </div>
                <div id="badge_stay" class="pill">Pendiente</div>
              </div>
              <div class="progress"><div id="bar_stay" class="bar"></div></div>
            </div>

            <div class="stage" onclick="openStage('checkout')">
              <div class="stage-top">
                <div>
                  <h4>Check-out</h4>
                  <p>Cierra ventas futuras: directo + reseña + retorno.</p>
                </div>
                <div id="badge_checkout" class="pill">Pendiente</div>
              </div>
              <div class="progress"><div id="bar_checkout" class="bar"></div></div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="btn-row">
            <button class="btn-ghost" onclick="showSearch()">Cambiar habitación</button>
            <button class="btn-ghost" onclick="goHome()">Salir</button>
          </div>
        </div>
      </div>

      <!-- FLOW -->
      <div id="flow" class="hidden">
        <div class="header">
          <div>
            <h3 id="flowTitle"></h3>
            <div class="sub" id="flowSub">Marca una opción y se habilita el siguiente ítem (flujo guiado).</div>
          </div>
          <div class="row">
            <button class="btn-ghost btn-full" onclick="goHome()">Volver</button>
            <button class="btn-ghost" onclick="resetStage()">Reiniciar etapa</button>
          </div>
        </div>

        <div class="content">
          <div class="flow-layout">
            <div class="stage-nav">
              <div class="stage" data-stage="checkin" onclick="openStage('checkin')">
                <div class="stage-top">
                  <div>
                    <h4>Check-in</h4>
                    <p>Empieza bien la conversación.</p>
                  </div>
                  <div id="nav_badge_checkin" class="pill">Pendiente</div>
                </div>
                <div class="progress"><div id="nav_bar_checkin" class="bar"></div></div>
              </div>

              <div class="stage" data-stage="stay" onclick="openStage('stay')">
                <div class="stage-top">
                  <div>
                    <h4>Estadía</h4>
                    <p>Ventas fáciles sin presión.</p>
                  </div>
                  <div id="nav_badge_stay" class="pill">Pendiente</div>
                </div>
                <div class="progress"><div id="nav_bar_stay" class="bar"></div></div>
              </div>

              <div class="stage" data-stage="checkout" onclick="openStage('checkout')">
                <div class="stage-top">
                  <div>
                    <h4>Check-out</h4>
                    <p>Última oportunidad de cierre.</p>
                  </div>
                  <div id="nav_badge_checkout" class="pill">Pendiente</div>
                </div>
                <div class="progress"><div id="nav_bar_checkout" class="bar"></div></div>
              </div>
            </div>

            <div class="flow-main">
              <div id="flowItems" class="flow-list"></div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="btn-row">
            <button class="btn-ghost btn-full" onclick="goHome()">Volver</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
  const DATA = {
    checkin: [
      { title: "¿Viaje de trabajo o descanso?", hint: "Personaliza la estadía" },
      { title: "Ofrecer upgrade de habitación", hint: "Mejora la experiencia" },
      { title: "Ofrecer desayuno", hint: "Empieza el día fácil" },
      { title: "Estacionamiento o traslado", hint: "Evita preocupaciones" }
    ],
    stay: [
      { title: "¿Todo bien con la habitación?", hint: "Confirma comodidad" },
      { title: "Ofrecer late check-out", hint: "Cierra con calma" },
      { title: "Invitar a bar o restaurante", hint: "Momento perfecto" },
      { title: "Experiencia o tour", hint: "Recuerdos únicos" }
    ],
    checkout: [
      { title: "¿Cómo estuvo la estadía?", hint: "Escucha y aprende" },
      { title: "Late check-out hoy", hint: "Última oportunidad" },
      { title: "Reservar directo", hint: "Beneficio inmediato" },
      { title: "Pedir reseña", hint: "Impulsa la reputación" }
    ]
  };

  const KEY = "hotel-guests-modern";
  const THEME_KEY = "hotel-theme";
  let guests = JSON.parse(localStorage.getItem(KEY) || "{}");
  let currentRoom = null;
  let currentStage = null;

  const qs = (id) => document.getElementById(id);

  function save(){
    localStorage.setItem(KEY, JSON.stringify(guests));
    updateKPIs();
  }

  function toast(msg){
    const t = qs("toast");
    t.textContent = msg;
    t.style.display = "block";
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(()=> t.style.display="none", 1400);
  }

  function hideAll(){
    ["home","newGuest","search","stages","flow"].forEach(i => qs(i).classList.add("hidden"));
  }
  function goHome(){
    hideAll();
    qs("home").classList.remove("hidden");
    updateKPIs();
  }

  function showNew(){
    hideAll();
    qs("roomInput").value = "";
    qs("newGuest").classList.remove("hidden");
    setTimeout(()=>qs("roomInput").focus(), 50);
  }

  function showSearch(){
    hideAll();
    qs("searchInput").value = "";
    renderGuestList();
    qs("search").classList.remove("hidden");
    setTimeout(()=>qs("searchInput").focus(), 50);
  }

  function normalizeRoom(v){
    return (v || "").trim();
  }

  function createGuest(){
    const room = normalizeRoom(qs("roomInput").value);
    if(!room) return alert("Ingresa habitación");

    // si existe, no sobrescribimos: continuamos
    if(!guests[room]){
      guests[room] = { flows:{}, createdAt: Date.now() };
      save();
      toast("Huésped creado");
    }else{
      toast("Habitación existente: continuando");
    }
    openGuest(room);
  }

  function openGuest(room){
    currentRoom = room;
    qs("roomTitle").textContent = room;
    openStage("checkin");
  }

  function deleteCurrent(){
    if(!currentRoom) return;
    const ok = confirm("¿Borrar esta habitación y su progreso?");
    if(!ok) return;
    delete guests[currentRoom];
    save();
    toast("Huésped borrado");
    currentRoom = null;
    showSearch();
  }

  function renderGuestList(){
    const list = qs("guestList");
    list.innerHTML = "";

    const q = (qs("searchInput").value || "").trim().toLowerCase();
    const rooms = Object.keys(guests)
      .filter(r => r.toLowerCase().includes(q))
      .sort((a,b)=> a.localeCompare(b, undefined, {numeric:true}));

    if(rooms.length === 0){
      list.innerHTML = `<div class="muted">No hay huéspedes activos.</div>`;
      return;
    }

    rooms.forEach(r=>{
      const status = overallStatus(r);
      const c = document.createElement("div");
      c.className = "guest-card";

      const pillClass = status.kind === "ok" ? "ok" : status.kind === "warn" ? "warn" : "";
      c.innerHTML = `
        <div class="guest-top">
          <div class="room">
            <div class="pill">Hab. ${escapeHtml(r)}</div>
          </div>
          <div class="pill ${pillClass}">${escapeHtml(status.label)}</div>
        </div>

        <div class="mini">
          <div class="tag">Check-in: ${stagePercent(r,'checkin')}%</div>
          <div class="tag">Estadía: ${stagePercent(r,'stay')}%</div>
          <div class="tag">Check-out: ${stagePercent(r,'checkout')}%</div>
        </div>

        <div class="guest-actions">
          <button class="btn-primary" onclick="openGuest('${escapeAttr(r)}')">Continuar</button>
          <button class="btn-danger" onclick="deleteGuest('${escapeAttr(r)}')">Borrar</button>
        </div>
      `;
      list.appendChild(c);
    });
  }

  function deleteGuest(room){
    const ok = confirm(`¿Borrar habitación ${room} y su progreso?`);
    if(!ok) return;
    delete guests[room];
    save();
    toast("Huésped borrado");
    renderGuestList();
  }

  function openStage(stage){
    currentStage = stage;
    hideAll();
    qs("flowTitle").textContent =
      (stage === "checkin" ? "Check-in" : stage === "stay" ? "Estadía" : "Check-out")
      + " — Hab. " + currentRoom;

    qs("flowSub").textContent = "Marca los ítems en el orden que prefieras.";
    renderFlow();
    updateStageCards();
    qs("flow").classList.remove("hidden");
  }

  function backToStages(){
    hideAll();
    qs("stages").classList.remove("hidden");
    updateStageCards();
  }

  function resetStage(){
    if(!currentRoom || !currentStage) return;
    const ok = confirm("¿Reiniciar esta etapa (se borran respuestas)?");
    if(!ok) return;
    guests[currentRoom].flows[currentStage] = {};
    save();
    toast("Etapa reiniciada");
    renderFlow();
  }

  function renderFlow(){
    const wrap = qs("flowItems");
    wrap.innerHTML = "";

    const flow = (guests[currentRoom].flows[currentStage] || {});

    DATA[currentStage].forEach((item,i)=>{
      const state = flow[i] || "new";

      const d = document.createElement("div");
      d.className = "item";
      d.innerHTML = `
        <div class="item-text">
          <strong>${escapeHtml(item.title)}</strong>
          <span class="item-sub">“${escapeHtml(item.hint)}”</span>
        </div>
        <div class="item-actions">
          <button class="${state === 'no' ? 'active' : 'muted'}" onclick="setState(${i},'no')">No ofrecido</button>
          <button class="${state === 'offered' ? 'active' : ''}" onclick="setState(${i},'offered')">Ofrecido</button>
          <button class="accepted ${state === 'accepted' ? 'active' : ''}" onclick="setState(${i},'accepted')">Aceptado</button>
        </div>
      `;
      wrap.appendChild(d);
    });

    const completed = DATA[currentStage].every((_, i) => flow[i]);
    if(completed){
      qs("flowSub").textContent = "Etapa completa ✅ Puedes volver o pasar a la siguiente.";
    } else {
      qs("flowSub").textContent = "Marca los ítems en el orden que prefieras.";
    }
    updateStageCards();
  }

  function setState(i,val){
    guests[currentRoom].flows[currentStage] ||= {};
    const flow = guests[currentRoom].flows[currentStage];
    flow[i] = val;
    save();
    if(val === "accepted") toast("Aceptado");
    else if(val === "offered") toast("Ofrecido");
    else toast("No ofrecido");
    renderFlow();
  }

  function stagePercent(room, stage){
    const flow = (guests[room]?.flows?.[stage] || {});
    const total = DATA[stage].length;
    let done = 0;
    for(let i=0;i<total;i++){
      if(flow[i]) done++;
    }
    return Math.round((done/total)*100);
  }

  function stageStatus(room, stage){
    const p = stagePercent(room, stage);
    if(p === 0) return { label:"Pendiente", kind:"" };
    if(p < 100) return { label:"En curso", kind:"warn" };
    return { label:"Completo", kind:"ok" };
  }

  function overallStatus(room){
    const a = stagePercent(room,'checkin');
    const b = stagePercent(room,'stay');
    const c = stagePercent(room,'checkout');
    const avg = Math.round((a+b+c)/3);
    if(avg === 0) return { label:"Pendiente", kind:"" };
    if(avg < 100) return { label:"En curso", kind:"warn" };
    return { label:"Completo", kind:"ok" };
  }

  function updateStageCards(){
    if(!currentRoom) return;
    ["checkin","stay","checkout"].forEach(stage=>{
      const s = stageStatus(currentRoom, stage);
      const badge = qs("badge_"+stage);
      const bar = qs("bar_"+stage);
      if(badge){
        badge.textContent = s.label;
        badge.className = "pill " + (s.kind ? s.kind : "");
      }
      if(bar){
        bar.style.width = stagePercent(currentRoom, stage) + "%";
      }

      const navBadge = qs("nav_badge_"+stage);
      const navBar = qs("nav_bar_"+stage);
      if(navBadge){
        navBadge.textContent = s.label;
        navBadge.className = "pill " + (s.kind ? s.kind : "");
      }
      if(navBar){
        navBar.style.width = stagePercent(currentRoom, stage) + "%";
      }
    });

    document.querySelectorAll(".stage-nav .stage").forEach((el)=>{
      const isActive = el.dataset.stage === currentStage;
      el.classList.toggle("active", isActive);
    });
  }

  function updateKPIs(){
    const n = Object.keys(guests).length;
    qs("kpiActive").textContent = n;
    const now = new Date();
    qs("kpiToday").textContent = now.toLocaleDateString("es-CL", { weekday:"short", day:"2-digit", month:"short" });
  }

  function hardReset(){
    const ok = confirm("¿Reiniciar TODO? (se borran todas las habitaciones y progreso)");
    if(!ok) return;
    guests = {};
    save();
    toast("Reiniciado");
    goHome();
  }

  function applyTheme(mode){
    const isLight = mode === "light";
    document.body.classList.toggle("light", isLight);
    const label = qs("themeLabel");
    const input = qs("themeSwitch");
    if(label) label.textContent = isLight ? "Modo claro" : "Modo oscuro";
    if(input){
      input.checked = isLight;
      input.setAttribute("aria-label", isLight ? "Cambiar a modo oscuro" : "Cambiar a modo claro");
    }
  }

  function initTheme(){
    const stored = localStorage.getItem(THEME_KEY);
    const prefersLight = window.matchMedia && window.matchMedia("(prefers-color-scheme: light)").matches;
    const mode = stored || (prefersLight ? "light" : "dark");
    applyTheme(mode);
  }

  function toggleTheme(){
    const isLight = document.body.classList.contains("light");
    const next = isLight ? "dark" : "light";
    localStorage.setItem(THEME_KEY, next);
    applyTheme(next);
  }

  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function escapeAttr(str){
    // para usar en onclick con comillas simples
    return String(str).replaceAll("\\","\\\\").replaceAll("'","\\'");
  }

  // init
  updateKPIs();
  initTheme();
  goHome();

  const themeSwitch = qs("themeSwitch");
  if(themeSwitch){
    themeSwitch.addEventListener("change", toggleTheme);
  }
</script>
</body>
</html>
